openapi: 3.0.0
info:
  title: URL Shortener API
  description: |
    Comprehensive API documentation for the URL Shortener service. 
    This API allows users to manage their profile, shorten URLs, view analytics, and perform administrative tasks.
    
    ### Security
    Most routes require a **Bearer Token (JWT)**. Some operations additionally require **Email Verification** or **Admin Roles**.
  version: 1.0.0
  contact:
    name: Support Team
    email: support@example.com

servers:
  - url: /
    description: Main API server

tags:
  - name: Authentication
    description: User registration, login, and token management
  - name: Profile
    description: Management of the authenticated user's profile
  - name: Short Links
    description: Core functionality for creating and managing short URLs
  - name: Verification & Password
    description: Email verification and password recovery flows
  - name: Admin
    description: Administrative tools for user management
  - name: Public
    description: Publicly accessible routes
  - name: System
    description: Service health and monitoring

paths:
  /api/health:
    get:
      tags: [System]
      summary: Health check
      description: Returns the health status of the API and its database connection.
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              example: { status: "up", database: "connected" }
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/auth/register:
    post:
      tags: [Authentication]
      summary: Register a new user
      description: Creates a new user account and sends a verification email.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password, password_confirmation]
              properties:
                name: { type: string, example: "John Doe" }
                email: { type: string, format: email, example: "john@example.com" }
                password: { type: string, minLength: 8, example: "password123" }
                password_confirmation: { type: string, example: "password123" }
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessMessage'
                  - $ref: '#/components/schemas/AuthToken'
        '422':
          $ref: '#/components/responses/ValidationError'

  /api/auth/login:
    post:
      tags: [Authentication]
      summary: User login
      description: Returns a JWT token upon successful authentication.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email, example: "john@example.com" }
                password: { type: string, example: "password123" }
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthToken'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/validate-token:
    post:
      tags: [Authentication]
      summary: Validate JWT token
      description: Checks if a token is still valid and returns the associated user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token: { type: string }
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid: { type: boolean, example: true }
                  user: { $ref: '#/components/schemas/User' }
        '401':
          description: Token is invalid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid: { type: boolean, example: false }

  /api/auth/logout:
    post:
      tags: [Authentication]
      summary: Logout user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully logged out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/user:
    get:
      tags: [Authentication]
      summary: Get current authenticated user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/email/verify/{id}/{hash}:
    get:
      tags: [Verification & Password]
      summary: Verify email address
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
        - name: hash
          in: path
          required: true
          schema: { type: string }
        - name: expires
          in: query
          required: true
          schema: { type: integer }
        - name: signature
          in: query
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Email verified successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }
        '403':
          description: Invalid or expired verification link
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorMessage' }

  /api/email/resend:
    post:
      tags: [Verification & Password]
      summary: Resend verification email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email: { type: string, format: email, example: "john@example.com" }
      responses:
        '200':
          description: Verification link sent
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }
        '404':
          $ref: '#/components/responses/NotFound'

  /api/forgot-password:
    post:
      tags: [Verification & Password]
      summary: Request password reset link
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email: { type: string, format: email, example: "john@example.com" }
      responses:
        '200':
          description: Reset link sent (status is always 200 for security)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }

  /api/reset-password:
    post:
      tags: [Verification & Password]
      summary: Reset password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, email, password, password_confirmation]
              properties:
                token: { type: string }
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
                password_confirmation: { type: string }
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorMessage' }

  /api/profile:
    get:
      tags: [Profile]
      summary: Get user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profile data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
    put:
      tags: [Profile]
      summary: Update profile
      description: Requires a verified email address.
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, example: "John New Doe" }
                password: { type: string, minLength: 8 }
                password_confirmation: { type: string }
                previous_password: { type: string }
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      message: { type: string, example: "User updated" }
                  - $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '422':
          $ref: '#/components/responses/ValidationError'
    delete:
      tags: [Profile]
      summary: Delete account
      description: Permanently deletes the authenticated user's account. Requires a verified email address.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Account deleted successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'

  /api/short-links:
    get:
      tags: [Short Links]
      summary: List user short links
      description: Returns a paginated list of short links owned by the user. Requires a verified email address.
      security:
        - bearerAuth: []
      parameters:
        - name: per_page
          in: query
          schema: { type: integer, default: 50 }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
      responses:
        '200':
          description: Paginated list of links
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedShortLinks'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
    post:
      tags: [Short Links]
      summary: Create short link
      description: Creates a new shortened URL. Requires a verified email address.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [original_url]
              properties:
                original_url: { type: string, format: url, example: "https://example.com/very/long/path" }
                expires_at: { type: string, format: date-time, example: "2026-12-31T23:59:59Z" }
      responses:
        '201':
          description: Link created successfully
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      message: { type: string, example: "Short link created" }
                  - $ref: '#/components/schemas/ShortLink'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '422':
          $ref: '#/components/responses/ValidationError'

  /api/short-links/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, example: "1" }
    get:
      tags: [Short Links]
      summary: Get link details
      description: Returns full details for a specific short link. Requires a verified email address.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Short link details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShortLink'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Short Links]
      summary: Update link
      description: Updates the destination or expiry of a short link. Requires a verified email address.
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                original_url: { type: string, format: url }
                expires_at: { type: string, format: date-time, nullable: true }
      responses:
        '200':
          description: Link updated
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      message: { type: string, example: "Short link updated" }
                  - $ref: '#/components/schemas/ShortLink'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
    delete:
      tags: [Short Links]
      summary: Delete link
      description: Removes a short link from the system. Requires a verified email address.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Link deleted successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/short-links/bulk-delete:
    post:
      tags: [Short Links]
      summary: Bulk delete links
      description: Deletes multiple short links at once. Requires a verified email address.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ids]
              properties:
                ids:
                  type: array
                  items: { type: integer }
                  example: [1, 2, 3]
      responses:
        '200':
          description: Links deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "3 links deleted" }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '422':
          $ref: '#/components/responses/ValidationError'

  /api/users:
    get:
      tags: [Admin]
      summary: List all users
      description: Returns a paginated list of all users. Requires **Admin** access and a **Verified Email**.
      security:
        - bearerAuth: []
      parameters:
        - name: role
          in: query
          schema: { type: string, enum: [user, admin] }
        - name: search
          in: query
          schema: { type: string, example: "John" }
        - name: per_page
          in: query
          schema: { type: integer, default: 50 }
      responses:
        '200':
          description: Paginated user list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/User' }
                  links: { $ref: '#/components/schemas/PaginatedLinks' }
                  meta: { $ref: '#/components/schemas/PaginatedMeta' }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
    post:
      tags: [Admin]
      summary: Create a user
      description: Manually creates a new user account. Requires **Admin** access and a **Verified Email**.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password, password_confirmation, role]
              properties:
                name: { type: string, example: "New Admin" }
                email: { type: string, format: email, example: "newadmin@example.com" }
                password: { type: string, minLength: 8, example: "password123" }
                password_confirmation: { type: string, example: "password123" }
                role: { type: string, enum: [user, admin], example: "admin" }
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      message: { type: string, example: "User created successfully" }
                  - $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '422':
          $ref: '#/components/responses/ValidationError'

  /api/users/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: string, example: "1" }
    get:
      tags: [Admin]
      summary: Get user details
      description: Returns full details for a specific user. Requires **Admin** access and a **Verified Email**.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User data
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Admin]
      summary: Update user
      description: Manually updates user information. Requires **Admin** access and a **Verified Email**.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, role]
              properties:
                name: { type: string, example: "Updated Name" }
                email: { type: string, format: email, example: "updated@example.com" }
                role: { type: string, enum: [user, admin], example: "user" }
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                allOf:
                  - type: object
                    properties:
                      message: { type: string, example: "User updated" }
                  - $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
    delete:
      tags: [Admin]
      summary: Delete user
      description: Manually deletes a user account. Requires Admin access and a verified email address.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessMessage' }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/UnauthorizedAccess'
        '404':
          $ref: '#/components/responses/NotFound'

  /{code}:
    parameters:
      - name: code
        in: path
        required: true
        schema: { type: string, example: "abc123" }
    get:
      tags: [Public]
      summary: Redirect to original URL
      description: Public endpoint that redirects a short link code to its destination.
      responses:
        '302':
          description: Redirecting to original URL
          headers:
            Location:
              schema: { type: string, example: "https://example.com" }
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          description: Link expired
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorMessage' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "John Doe" }
        email: { type: string, format: email, example: "john@example.com" }
        email_verified: { type: boolean, example: true }
        role: { type: string, enum: [user, admin], example: "user" }
        created_at: { type: string, format: date-time, example: "2026-01-01T12:00:00.000000Z" }
        updated_at: { type: string, format: date-time, example: "2026-01-01T12:00:00.000000Z" }

    ShortLink:
      type: object
      properties:
        id: { type: integer, example: 123 }
        original_url: { type: string, format: url, example: "https://google.com" }
        short_code: { type: string, example: "abc123" }
        short_url: { type: string, example: "http://localhost:8000/abc123" }
        visits_count: { type: integer, example: 5 }
        expires_at: { type: string, format: date-time, nullable: true, example: "2026-12-31T23:59:59Z" }
        is_expired: { type: boolean, example: false }
        is_valid: { type: boolean, example: true }
        user_id: { type: integer, example: 1 }
        created_at: { type: string, format: date-time, example: "2026-01-01T12:00:00.000000Z" }
        updated_at: { type: string, format: date-time, example: "2026-01-01T12:00:00.000000Z" }

    AuthToken:
      type: object
      properties:
        access_token: { type: string, example: "eyJhbGciOiJIUzI1NiIsInR5..." }
        token_type: { type: string, example: "bearer" }
        expires_in: { type: integer, example: 3600 }

    PaginatedShortLinks:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/ShortLink' }
        links: { $ref: '#/components/schemas/PaginatedLinks' }
        meta: { $ref: '#/components/schemas/PaginatedMeta' }

    PaginatedLinks:
      type: object
      properties:
        first: { type: string, example: "http://localhost:8000/api/links?page=1" }
        last: { type: string, example: "http://localhost:8000/api/links?page=10" }
        prev: { type: string, nullable: true }
        next: { type: string, example: "http://localhost:8000/api/links?page=2", nullable: true }

    PaginatedMeta:
      type: object
      properties:
        current_page: { type: integer, example: 1 }
        from: { type: integer, example: 1 }
        last_page: { type: integer, example: 10 }
        path: { type: string, example: "http://localhost:8000/api/links" }
        per_page: { type: integer, example: 50 }
        to: { type: integer, example: 50 }
        total: { type: integer, example: 500 }

    SuccessMessage:
      type: object
      properties:
        message: { type: string, example: "Operation successful" }

    ErrorMessage:
      type: object
      properties:
        message: { type: string, example: "An error occurred" }

    ValidationErrorStructure:
      type: object
      properties:
        message: { type: string, example: "The given data was invalid." }
        errors:
          type: object
          additionalProperties:
            type: array
            items: { type: string }
          example:
            email: ["The email field is required."]
            password: ["The password confirmation does not match."]

  responses:
    Unauthorized:
      description: Unauthorized - Token missing or invalid
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorMessage' }
          example: { message: "Unauthenticated." }
    
    UnauthorizedAccess:
      description: Unauthorized Access - Email not verified or missing permissions
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorMessage' }
          example: { message: "Unauthorized access" }

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorMessage' }
          example: { message: "Resource not found" }

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ValidationErrorStructure' }

    ServiceUnavailable:
      description: Service Unavailable
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorMessage' }
          example: { message: "Service Unavailable" }
